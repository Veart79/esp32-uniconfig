# esp32-uniconfig
Universal firmware for esp32 with json config by API (wifi) or RS485

Прошивка для ESP32

Описание конфигурации
Конфигурация для работы контроллера задается в виде JSON-объекта, который состоит их трех разделов: Датчики (sensors), Действия (actions) и Правила (rules)
{
  "sensors": {
    "temp": {"type": "ds18b20", "pin": 25}    
  },          
  "actions": {
    "enableLed":  {"pin": 26, "level": 1}, 
    "disableLed": {"pin": 26, "level": 0}, 
    "enablePump": {"pin": 21, "level": 1}
  },
  "rules":   [
    {"sensor": "temp", "max": 30, "action": "enableLed"}, 
    {"sensor": "temp", "min": 28, "action": "disableLed"}
  ]
}



Датчики (sensors) 
Датчики (sensors) - объект, который содержит именованный список датчиков с указанием типа датчика и ножки GPIO к которой он подключен ("pin": 25). На данный момент поддерживается только тип "ds18b20"  ("type": "ds18b20"). Имя датчика ("temp":) используется для идентификации датчика и его использования в правилах работы контроллера.

Таким образом в примере мы задали датчик с именем "temp", его тип "ds18b20" и он подключен к 25й ножке контроллера (желтый провод для передачи данных).

Если требуется прописать более одного датчика - добавляем еще один через запятую:
  "sensors": {
    "temp":   {"type": "ds18b20", "pin": 25},
    "temp26": {"type": "ds18b20", "pin": 26}        
  },


Действия (actions) 
Данный объект содержит именованный список действий с указанием ножки GPIO и уровня сигнала, который будет на нее подан (1 - HIGH,  2 - LOW (GND)) при срабатывании этого действия.
Имя действия  (напр. "enableLed":) необходимо для его использования в правилах работы контроллера.
Напр. действие    "enableLed":  {"pin": 26, "level": 1}, 
означает что на ножку  GPIO 26 будет подано напряжения (высокий уровень).
Правила (rules)
Правила задают алгоритм работы контроллера. Они бесконечно выполняются в основном рабочем цикле контроллера. Если условия, указанные в правиле срабатывают, то выполняется указанное в правиле действие.
Действие задается в параметре "action", в котором указывается название действия из раздела “actions”.

Обратите внимание, что правила представляют собой массив, а не объект (т.е. они не имеют имен).

Напр. правило:  {"sensor": "temp", "max": 29, "action": "enableLed"}
Означает, что если значение датчика "temp" (который описан в разделе sensors) достигло (или превысило) значение 29 градусов, то выполнится действие "enableLed" (которое описано в разделе actions).  В данном примере подастся напряжение на 26й пин на котором загорится светодиод.

Правило   {"sensor": "temp", "min": 28, "action": "disableLed"}  
выключит светодиод на том же 26м пине, выполнив действие  "disableLed" если температура опустится до 28 градусов или ниже.


Примечания.
Старайтесь использовать понятные названия в именовании датчиков и действий, чтобы конфигурация легко читалась. В то же время не используйте длинные имена, потому что размеры конфигурации ограничены размером 1кБ (1024 символа).

Пример конфигурации, который указан выше можно использовать для тестирования. На 26й пин подключить диод, на 25й - датчик температуры. Если нагреть датчик в руке до 30 градусов - загорится диод. Если отпустить датчик и подождать пока он остынет до 28 градусов - диод потухнет.


API (WiFi)
Url - IP адрес смотрим в логе контроллера или на роутере или сканим сеть.

GET http://192.168.1.100/data  - получить данные текущей конфигурации
GET http://192.168.1.100/getSensorData  - получить данные по датчикам
POST http://192.168.1.100/setConfig - в теле запроса передаем json с новым конфигом
  